name: Release

on:
  push:
    tags: ['v*']

permissions:
  contents: write

jobs:
  build-linux:
    name: Build Linux
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'
          cache: true

      - name: Install musl toolchain
        run: sudo apt-get update && sudo apt-get install -y musl-dev musl-tools

      - name: Install zig
        uses: goto-bus-stop/setup-zig@v2
        with:
          version: 0.13.0

      - name: Build all Linux platforms
        run: make bin-amd64 bin-arm64

      - name: Upload Linux binaries
        uses: actions/upload-artifact@v4
        with:
          name: linux-binaries
          path: |
            bin/amd64/
            bin/arm64/

  build-macos:
    name: Build macOS
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'
          cache: true

      - name: Build macOS arm64
        run: make bin-darwin-arm64

      - name: Build macOS amd64
        run: make bin-darwin-amd64

      - name: Upload macOS binaries
        uses: actions/upload-artifact@v4
        with:
          name: macos-binaries
          path: |
            bin/darwin-amd64/
            bin/darwin-arm64/

  release:
    name: Release
    needs: [build-linux, build-macos]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'
          cache: true

      - name: Download Linux binaries
        uses: actions/download-artifact@v4
        with:
          name: linux-binaries
          path: bin/

      - name: Download macOS binaries
        uses: actions/download-artifact@v4
        with:
          name: macos-binaries
          path: bin/

      - name: Package release archives
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          BINARIES="apshell apsignerd apadmin apapprover apstore passfile"
          mkdir -p dist

          # Linux archives
          for arch in amd64 arm64; do
            archive="aplane_${VERSION}_linux_${arch}.tar.gz"
            tar -czf "dist/${archive}" -C "bin/${arch}" $BINARIES
            echo "Created dist/${archive}"
          done

          # macOS archives
          for arch in amd64 arm64; do
            archive="aplane_${VERSION}_darwin_${arch}.tar.gz"
            tar -czf "dist/${archive}" -C "bin/darwin-${arch}" $BINARIES
            echo "Created dist/${archive}"
          done

          # Generate checksums
          cd dist
          sha256sum *.tar.gz > checksums.txt
          cd ..
          echo "Generated dist/checksums.txt"
          cat dist/checksums.txt

      - name: Install minisign
        run: go install aead.dev/minisign/cmd/minisign@latest

      - name: Sign checksums
        run: |
          printf '%s\n' "untrusted comment: minisign encrypted secret key" "$MINISIGN_SECRET_KEY" > /tmp/minisign.key
          minisign -S -s /tmp/minisign.key -m dist/checksums.txt
          rm -f /tmp/minisign.key
        env:
          MINISIGN_SECRET_KEY: ${{ secrets.MINISIGN_KEY }}

      - name: Generate changelog
        run: |
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          if [ -n "$PREV_TAG" ]; then
            echo "## Changes since ${PREV_TAG}" > dist/changelog.md
            echo "" >> dist/changelog.md
            git log --pretty=format:"- %s" "${PREV_TAG}..HEAD" >> dist/changelog.md
          else
            echo "## Initial release" > dist/changelog.md
          fi

      - name: Create release
        run: |
          gh release create "${{ github.ref_name }}" \
            --title "${{ github.ref_name }}" \
            --notes-file dist/changelog.md \
            dist/aplane_*.tar.gz \
            dist/checksums.txt \
            dist/checksums.txt.minisig
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
